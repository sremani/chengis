name: Clojure CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ===========================================================================
  # Job 1: Build & Test
  # ===========================================================================
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'

    - name: Install Leiningen
      uses: DeLaGuardo/setup-clojure@13.5
      with:
        lein: 2.11.2

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('project.clj') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Install dependencies
      run: lein deps

    - name: Run tests
      run: lein test

  # ===========================================================================
  # Job 2: Docker Build & Smoke Test
  # ===========================================================================
  docker-smoke:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        load: true
        tags: chengis:ci
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Start container
      run: |
        docker run -d \
          --name chengis-smoke \
          -p 8080:8080 \
          -e CHENGIS_AUTH_ENABLED=false \
          -e CHENGIS_METRICS_ENABLED=true \
          -e CHENGIS_AUDIT_ENABLED=false \
          chengis:ci

    - name: Wait for healthy
      run: |
        echo "Waiting for /health..."
        for i in $(seq 1 60); do
          if curl -sf http://localhost:8080/health >/dev/null 2>&1; then
            echo "Server healthy after ${i}s"
            exit 0
          fi
          sleep 2
        done
        echo "Server failed to start within 120s"
        docker logs chengis-smoke
        exit 1

    - name: Validate /health
      run: |
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/health)
        if [ "$STATUS" != "200" ]; then
          echo "FAIL: /health returned $STATUS"
          exit 1
        fi
        BODY=$(curl -sf http://localhost:8080/health)
        echo "/health: $BODY"
        echo "$BODY" | grep -q '"status"' || { echo "FAIL: missing status field"; exit 1; }

    - name: Validate /ready
      run: |
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/ready)
        if [ "$STATUS" != "200" ]; then
          echo "FAIL: /ready returned $STATUS"
          exit 1
        fi
        echo "/ready: HTTP 200 OK"

    - name: Validate /startup
      run: |
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/startup)
        if [ "$STATUS" != "200" ]; then
          echo "FAIL: /startup returned $STATUS"
          exit 1
        fi
        echo "/startup: HTTP 200 OK"

    - name: Validate /metrics
      run: |
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/metrics)
        if [ "$STATUS" != "200" ]; then
          echo "FAIL: /metrics returned $STATUS"
          exit 1
        fi
        BODY=$(curl -sf http://localhost:8080/metrics)
        echo "$BODY" | grep -q "jvm_memory" || { echo "FAIL: no JVM metrics"; exit 1; }
        echo "/metrics: HTTP 200, JVM metrics present"

    - name: Show Java version in container
      run: docker exec chengis-smoke java -version

    - name: Stop container
      if: always()
      run: docker stop chengis-smoke && docker rm chengis-smoke

  # ===========================================================================
  # Job 3: E2E Integration Test
  # ===========================================================================
  e2e:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'

    - name: Install Leiningen
      uses: DeLaGuardo/setup-clojure@13.5
      with:
        lein: 2.11.2

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('project.clj') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Install dependencies
      run: lein deps

    - name: Start Chengis server
      run: |
        # Create temp workspace
        mkdir -p /tmp/chengis-e2e/workspaces /tmp/chengis-e2e/artifacts
        export CHENGIS_DATABASE_PATH=/tmp/chengis-e2e/chengis.db
        export CHENGIS_WORKSPACE_ROOT=/tmp/chengis-e2e/workspaces
        export CHENGIS_ARTIFACTS_ROOT=/tmp/chengis-e2e/artifacts
        export CHENGIS_SERVER_PORT=8080
        export CHENGIS_AUTH_ENABLED=false
        export CHENGIS_METRICS_ENABLED=true
        export CHENGIS_AUDIT_ENABLED=false
        export CHENGIS_SCHEDULER_ENABLED=false
        lein run serve > /tmp/chengis-e2e/server.log 2>&1 &
        echo $! > /tmp/chengis-e2e/server.pid
        echo "Server PID: $(cat /tmp/chengis-e2e/server.pid)"

    - name: Wait for server ready
      run: |
        echo "Waiting for /startup..."
        for i in $(seq 1 90); do
          if curl -sf http://localhost:8080/startup >/dev/null 2>&1; then
            echo "Server ready after ${i}s"
            exit 0
          fi
          sleep 2
        done
        echo "Server failed to start within 180s"
        cat /tmp/chengis-e2e/server.log | tail -50
        exit 1

    - name: E2E — Health probes
      run: |
        echo "=== /health ==="
        curl -sf http://localhost:8080/health | head -c 200
        echo ""
        echo "=== /ready ==="
        curl -sf http://localhost:8080/ready | head -c 200
        echo ""
        echo "=== /metrics ==="
        curl -sf http://localhost:8080/metrics | head -5
        echo ""
        echo "All probes OK"

    - name: E2E — Verify web pages load
      run: |
        echo "=== GET / (dashboard) ==="
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/)
        echo "Dashboard: HTTP $STATUS"
        [ "$STATUS" = "200" ] || { echo "FAIL"; exit 1; }

        echo "=== GET /jobs ==="
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/jobs)
        echo "Jobs page: HTTP $STATUS"
        [ "$STATUS" = "200" ] || { echo "FAIL"; exit 1; }

        echo "=== GET /login ==="
        STATUS=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:8080/login)
        echo "Login page: HTTP $STATUS"
        [ "$STATUS" = "200" ] || { echo "FAIL"; exit 1; }

        echo "All web pages OK"

    - name: E2E — Create job and trigger build via CLI
      run: |
        # Use the same DB as the running server
        export CHENGIS_DATABASE_PATH=/tmp/chengis-e2e/chengis.db
        export CHENGIS_WORKSPACE_ROOT=/tmp/chengis-e2e/workspaces
        export CHENGIS_ARTIFACTS_ROOT=/tmp/chengis-e2e/artifacts

        echo "=== Initializing example project ==="
        mkdir -p /tmp/chengis-e2e/workspaces
        lein run -- init /tmp/chengis-e2e/workspaces/example 2>&1 || echo "(init may already exist)"

        echo ""
        echo "=== Listing jobs ==="
        lein run -- job list 2>&1 || echo "(no jobs yet)"

        echo ""
        echo "=== Verifying system status ==="
        lein run -- status 2>&1 || true

        echo "CLI smoke test completed"

    - name: Stop server
      if: always()
      run: |
        if [ -f /tmp/chengis-e2e/server.pid ]; then
          PID=$(cat /tmp/chengis-e2e/server.pid)
          kill "$PID" 2>/dev/null || true
          sleep 2
          kill -9 "$PID" 2>/dev/null || true
        fi

    - name: Upload server log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-server-log
        path: /tmp/chengis-e2e/server.log

  # ===========================================================================
  # Job 4: Load Test
  # ===========================================================================
  load-test:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '25'

    - name: Install Leiningen
      uses: DeLaGuardo/setup-clojure@13.5
      with:
        lein: 2.11.2

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('project.clj') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Install hey
      run: |
        wget -q https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64 -O /usr/local/bin/hey
        chmod +x /usr/local/bin/hey
        hey -h 2>&1 | head -1 || echo "hey installed"

    - name: Install dependencies
      run: lein deps

    - name: Start Chengis server
      run: |
        mkdir -p /tmp/chengis-load/workspaces /tmp/chengis-load/artifacts
        export CHENGIS_DATABASE_PATH=/tmp/chengis-load/chengis.db
        export CHENGIS_WORKSPACE_ROOT=/tmp/chengis-load/workspaces
        export CHENGIS_ARTIFACTS_ROOT=/tmp/chengis-load/artifacts
        export CHENGIS_SERVER_PORT=8080
        export CHENGIS_AUTH_ENABLED=false
        export CHENGIS_METRICS_ENABLED=true
        export CHENGIS_AUDIT_ENABLED=false
        export CHENGIS_SCHEDULER_ENABLED=false
        lein run serve > /tmp/chengis-load/server.log 2>&1 &
        echo $! > /tmp/chengis-load/server.pid

    - name: Wait for server ready
      run: |
        echo "Waiting for /health..."
        for i in $(seq 1 90); do
          if curl -sf http://localhost:8080/health >/dev/null 2>&1; then
            echo "Server ready after ${i}s"
            exit 0
          fi
          sleep 2
        done
        echo "Server failed to start within 180s"
        cat /tmp/chengis-load/server.log | tail -50
        exit 1

    - name: Load test — /health
      run: |
        echo "=== /health — 1000 requests, 10 concurrent ==="
        hey -n 1000 -c 10 -t 30 http://localhost:8080/health
        echo ""

    - name: Load test — /jobs
      run: |
        echo "=== /jobs — 500 requests, 10 concurrent ==="
        hey -n 500 -c 10 -t 30 http://localhost:8080/jobs
        echo ""

    - name: Load test — /metrics
      run: |
        echo "=== /metrics — 200 requests, 5 concurrent ==="
        hey -n 200 -c 5 -t 30 http://localhost:8080/metrics
        echo ""

    - name: Validate load test results
      run: |
        echo "=== Running load test with threshold validation ==="
        chmod +x scripts/load-test.sh

        # Run with relaxed CI thresholds (GitHub Actions runners have variable performance)
        scripts/load-test.sh \
          --base-url http://localhost:8080 \
          --concurrency 10 \
          --requests 500 \
          --p99-threshold 3000 \
          --p50-threshold 1000 \
          --error-threshold 2.0

    - name: Stop server
      if: always()
      run: |
        if [ -f /tmp/chengis-load/server.pid ]; then
          PID=$(cat /tmp/chengis-load/server.pid)
          kill "$PID" 2>/dev/null || true
          sleep 2
          kill -9 "$PID" 2>/dev/null || true
        fi

    - name: Upload server log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: load-test-server-log
        path: /tmp/chengis-load/server.log
