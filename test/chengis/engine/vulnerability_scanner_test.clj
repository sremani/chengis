(ns chengis.engine.vulnerability-scanner-test
  (:require [clojure.test :refer [deftest is testing use-fixtures]]
            [clojure.java.io :as io]
            [clojure.data.json :as json]
            [chengis.db.connection :as conn]
            [chengis.db.migrate :as migrate]
            [chengis.db.scan-store :as scan-store]
            [chengis.engine.vulnerability-scanner :as scanner]
            [chengis.engine.process :as process]))

(def test-db-path "/tmp/chengis-vulnscan-test.db")

(defn setup-db [f]
  (let [db-file (io/file test-db-path)]
    (when (.exists db-file) (.delete db-file)))
  (migrate/migrate! test-db-path)
  (f)
  (let [db-file (io/file test-db-path)]
    (when (.exists db-file) (.delete db-file))))

(use-fixtures :each setup-db)

;; ---------------------------------------------------------------------------
;; parse-trivy-results tests
;; ---------------------------------------------------------------------------

(deftest parse-trivy-results-test
  (testing "parse-trivy-results with sample Trivy JSON"
    (let [trivy-json (json/write-str
                       {:Results [{:Vulnerabilities [{:Severity "CRITICAL"}
                                                     {:Severity "HIGH"}
                                                     {:Severity "MEDIUM"}]}]})
          counts (scanner/parse-trivy-results trivy-json)]
      (is (= 1 (:critical counts)))
      (is (= 1 (:high counts)))
      (is (= 1 (:medium counts)))
      (is (= 0 (:low counts)))
      (is (= 3 (:total counts))))))

(deftest parse-trivy-results-empty-test
  (testing "parse-trivy-results with empty results"
    (let [trivy-json (json/write-str {:Results []})
          counts (scanner/parse-trivy-results trivy-json)]
      (is (= 0 (:critical counts)))
      (is (= 0 (:high counts)))
      (is (= 0 (:total counts))))))

(deftest parse-trivy-results-no-vulns-test
  (testing "parse-trivy-results with results but no vulnerabilities"
    (let [trivy-json (json/write-str {:Results [{}]})
          counts (scanner/parse-trivy-results trivy-json)]
      (is (= 0 (:total counts))))))

(deftest parse-trivy-results-malformed-test
  (testing "parse-trivy-results with malformed JSON returns zeroed counts"
    (let [counts (scanner/parse-trivy-results "not valid json")]
      (is (= 0 (:critical counts)))
      (is (= 0 (:high counts)))
      (is (= 0 (:medium counts)))
      (is (= 0 (:low counts)))
      (is (= 0 (:total counts))))))

;; ---------------------------------------------------------------------------
;; parse-grype-results tests
;; ---------------------------------------------------------------------------

(deftest parse-grype-results-test
  (testing "parse-grype-results with sample Grype JSON"
    (let [grype-json (json/write-str
                       {:matches [{:vulnerability {:severity "Critical"}}
                                  {:vulnerability {:severity "High"}}]})
          counts (scanner/parse-grype-results grype-json)]
      (is (= 1 (:critical counts)))
      (is (= 1 (:high counts)))
      (is (= 0 (:medium counts)))
      (is (= 0 (:low counts)))
      (is (= 2 (:total counts))))))

(deftest parse-grype-results-empty-test
  (testing "parse-grype-results with empty matches"
    (let [grype-json (json/write-str {:matches []})
          counts (scanner/parse-grype-results grype-json)]
      (is (= 0 (:critical counts)))
      (is (= 0 (:total counts))))))

;; ---------------------------------------------------------------------------
;; evaluate-threshold tests
;; ---------------------------------------------------------------------------

(deftest evaluate-threshold-critical-passes-test
  (testing "critical threshold passes when critical=0"
    (let [counts {:critical 0 :high 5 :medium 10 :low 20}]
      (is (true? (scanner/evaluate-threshold counts "critical"))))))

(deftest evaluate-threshold-critical-fails-test
  (testing "critical threshold fails when critical>0"
    (let [counts {:critical 1 :high 0 :medium 0 :low 0}]
      (is (false? (scanner/evaluate-threshold counts "critical"))))))

(deftest evaluate-threshold-high-fails-test
  (testing "high threshold fails when high>0"
    (let [counts {:critical 0 :high 3 :medium 0 :low 0}]
      (is (false? (scanner/evaluate-threshold counts "high"))))))

(deftest evaluate-threshold-high-fails-critical-test
  (testing "high threshold fails when critical>0 (higher severity)"
    (let [counts {:critical 2 :high 0 :medium 0 :low 0}]
      (is (false? (scanner/evaluate-threshold counts "high"))))))

(deftest evaluate-threshold-medium-fails-critical-test
  (testing "medium threshold fails when critical>0"
    (let [counts {:critical 1 :high 0 :medium 0 :low 0}]
      (is (false? (scanner/evaluate-threshold counts "medium"))))))

(deftest evaluate-threshold-medium-passes-test
  (testing "medium threshold passes when critical=0, high=0, medium=0"
    (let [counts {:critical 0 :high 0 :medium 0 :low 5}]
      (is (true? (scanner/evaluate-threshold counts "medium"))))))

;; ---------------------------------------------------------------------------
;; scan-build! tests
;; ---------------------------------------------------------------------------

(deftest scan-build-with-mocked-process-test
  (let [ds (conn/create-datasource test-db-path)]
    (testing "scan-build! with mocked process stores scan results"
      (let [trivy-output (json/write-str
                           {:Results [{:Vulnerabilities [{:Severity "HIGH"}
                                                         {:Severity "MEDIUM"}]}]})
            system {:db ds
                    :config {:feature-flags {:container-scanning true}
                             :container-scanning {:scanner "trivy"
                                                  :threshold "critical"
                                                  :targets ["myapp:latest"]}}}
            build-result {:build-id "build-scan-1"
                          :job-id "job-1"
                          :org-id "org-1"
                          :workspace "/tmp/test-ws"}]
        (with-redefs [process/execute-command (fn [_opts]
                                                {:exit-code 0
                                                 :stdout trivy-output
                                                 :stderr ""
                                                 :timed-out? false})]
          (let [results (scanner/scan-build! system build-result)]
            (is (some? results))
            (is (= 1 (count results)))
            ;; Verify persisted in DB
            (let [db-scans (scan-store/get-build-scans ds "build-scan-1")]
              (is (= 1 (count db-scans)))
              (is (= "trivy" (:scanner (first db-scans))))
              (is (= 0 (:critical-count (first db-scans))))
              (is (= 1 (:high-count (first db-scans))))
              (is (= 1 (:medium-count (first db-scans))))
              ;; Threshold is "critical", and critical=0, so should pass
              (is (= 1 (:passed (first db-scans)))))))))))

(deftest scan-build-tool-not-found-test
  (let [ds (conn/create-datasource test-db-path)]
    (testing "scan-build! with tool not found (exit-code 127) returns nil"
      (let [system {:db ds
                    :config {:feature-flags {:container-scanning true}
                             :container-scanning {:scanner "trivy"
                                                  :targets ["myapp:latest"]}}}
            build-result {:build-id "build-scan-nf"
                          :job-id "job-1"
                          :workspace "/tmp/test-ws"}]
        (with-redefs [process/execute-command (fn [_opts]
                                                {:exit-code 127
                                                 :stdout ""
                                                 :stderr "command not found"
                                                 :timed-out? false})]
          (let [results (scanner/scan-build! system build-result)]
            (is (nil? results))))))))

(deftest scan-build-feature-flag-disabled-test
  (let [ds (conn/create-datasource test-db-path)]
    (testing "scan-build! returns nil when feature flag disabled"
      (let [system {:db ds
                    :config {:feature-flags {:container-scanning false}}}
            build-result {:build-id "build-scan-off"
                          :job-id "job-1"}]
        (is (nil? (scanner/scan-build! system build-result)))))))

;; ---------------------------------------------------------------------------
;; scan-store CRUD tests
;; ---------------------------------------------------------------------------

(deftest scan-store-create-get-test
  (let [ds (conn/create-datasource test-db-path)]
    (testing "create and get build scans"
      (scan-store/create-scan! ds
        {:build-id "build-sc-1" :job-id "j1" :org-id "org-1"
         :scan-target "myapp:latest" :scanner "trivy"
         :critical-count 1 :high-count 2 :medium-count 3 :low-count 4
         :total-count 10 :pass-threshold "critical" :passed 0
         :results-json "{}"})
      (let [scans (scan-store/get-build-scans ds "build-sc-1")]
        (is (= 1 (count scans)))
        (is (= "trivy" (:scanner (first scans))))
        (is (= 1 (:critical-count (first scans))))
        (is (= 0 (:passed (first scans))))))))

(deftest scan-store-list-filtered-test
  (let [ds (conn/create-datasource test-db-path)]
    (testing "list scans filtered by passed status"
      (scan-store/create-scan! ds
        {:build-id "build-lf-1" :job-id "j1" :org-id "org-1"
         :scan-target "app:v1" :scanner "trivy"
         :critical-count 0 :high-count 0 :total-count 0
         :passed 1 :results-json "{}"})
      (scan-store/create-scan! ds
        {:build-id "build-lf-2" :job-id "j1" :org-id "org-1"
         :scan-target "app:v2" :scanner "trivy"
         :critical-count 3 :high-count 0 :total-count 3
         :passed 0 :results-json "{}"})
      ;; All scans
      (let [all (scan-store/list-scans ds :org-id "org-1")]
        (is (= 2 (count all))))
      ;; Only passed
      (let [passed (scan-store/list-scans ds :org-id "org-1" :passed 1)]
        (is (= 1 (count passed)))
        (is (= 1 (:passed (first passed)))))
      ;; Only failed
      (let [failed (scan-store/list-scans ds :org-id "org-1" :passed 0)]
        (is (= 1 (count failed)))
        (is (= 0 (:passed (first failed))))))))

(deftest scan-store-summary-test
  (let [ds (conn/create-datasource test-db-path)]
    (testing "get-scan-summary returns aggregate counts"
      (scan-store/create-scan! ds
        {:build-id "build-sum-1" :job-id "j1" :org-id "org-1"
         :scan-target "app:v1" :scanner "trivy"
         :total-count 5 :passed 1 :results-json "{}"})
      (scan-store/create-scan! ds
        {:build-id "build-sum-2" :job-id "j1" :org-id "org-1"
         :scan-target "app:v2" :scanner "trivy"
         :total-count 3 :passed 0 :results-json "{}"})
      (scan-store/create-scan! ds
        {:build-id "build-sum-3" :job-id "j1" :org-id "org-1"
         :scan-target "app:v3" :scanner "trivy"
         :total-count 0 :passed 1 :results-json "{}"})
      (let [summary (scan-store/get-scan-summary ds :org-id "org-1")]
        (is (= 3 (:total summary)))
        (is (= 2 (:passed summary)))
        (is (= 1 (:failed summary)))))))
